{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <!-- Mobile viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %} My Site {% endblock %}</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}" />

  <!-- Bootstrap CSS (keep versions consistent) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Your site CSS -->
  <link rel="stylesheet" href="{% static 'css/site.css' %}" />

  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

  <!-- IMPORTANT: load CKEditor **once** here (super-build). Do NOT load any other CKEditor build anywhere else. -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/super-build/ckeditor.js"></script>

  <meta name="google-site-verification" content="9r61zs3yCX6mCLG6_MyYsHzk8Ec-agEL95e4KEII-r0" />

  <style>
    /* ================== your original styles (kept) ================== */
    body {
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 30%, rgba(0, 123, 255, 0.4), transparent 70%),
        radial-gradient(circle at 80% 70%, rgba(0, 198, 255, 0.35), transparent 60%),
        radial-gradient(circle at 50% 100%, rgba(0, 86, 179, 0.4), transparent 70%);
      animation: aurora 21s ease-in-out infinite alternate;
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: radial-gradient(rgba(255, 255, 255, 0.3) 1.5px, transparent 1.5px);
      background-size: 100px 100px;
      animation: floatDots 90s linear infinite;
      z-index: -1;
      opacity: 0.4;
    }

    @keyframes aurora {
      0% {
        transform: translateY(0) scale(1);
        filter: blur(20px);
      }

      50% {
        transform: translateY(-10px) scale(1.03);
        filter: blur(25px);
      }

      100% {
        transform: translateY(0) scale(1);
        filter: blur(20px);
      }
    }

    @keyframes floatDots {
      from {
        background-position: 0 0
      }

      to {
        background-position: 300px 600px
      }
    }

    @keyframes navbarGradient {
      0% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0% 50%
      }
    }

    .navbar {
      background: linear-gradient(270deg, #212529, #343a40, #0dcaf0, #343a40, #212529);
      background-size: 400% 400%;
      animation: navbarGradient 10s ease infinite;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    form.d-flex {
      position: relative;
      background: rgba(255, 255, 255, .15);
      border-radius: 50px;
      padding: 4px 10px 4px 35px;
      border: 2px solid rgba(255, 255, 255, .3);
      backdrop-filter: blur(8px);
      transition: all .3s ease;
    }

    form.d-flex:focus-within {
      border-color: #0dcaf0;
      box-shadow: 0 0 15px rgba(13, 202, 240, .6);
    }

    form input[type='search'] {
      border: none;
      outline: none;
      background: transparent;
      border-radius: 50px;
      padding: 8px 14px;
      width: 180px;
      transition: width .4s ease, color .3s ease;
      font-size: 15px;
      color: #fff;
    }

    .btn-outline-success {
      border-radius: 50%;
      padding: 8px 12px;
      font-weight: 500;
      border: none;
      margin-left: 6px;
      background: linear-gradient(135deg, #0dcaf0, #007bff);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px rgba(13, 213, 240, .4);
    }

    .custom-dropdown-menu {
      min-width: 180px;
      border-radius: 10px;
      overflow: hidden;
    }

    footer {
      background: linear-gradient(90deg, #1e1e2f, #343a40, #1e1e2f);
      color: #ccc;
      padding: 40px 0;
      margin-top: 50px;
    }

    .avatar-badge {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #0dcaf0, #007bff);
      color: #fff;
      box-shadow: 0 0 8px rgba(13, 202, 240, .6);
    }

    /* === AI popup helper styles (kept) === */
    #ai-floating-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #4f46e5, #3b82f6);
      color: #fff;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(31, 41, 55, 0.18);
      z-index: 2000;
    }

    #ai-popup {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 360px;
      max-height: 520px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 20px 45px rgba(2, 6, 23, .25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 2001;
    }

    #ai-popup-header {
      background: linear-gradient(135deg, #4f46e5, #3b82f6);
      color: #fff;
      padding: 12px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }

    #ai-popup-body {
      padding: 12px;
      overflow-y: auto;
      font-size: .95rem;
      background: #f9fafb;
    }

    #ai-response .ai-bubble {
      background: #eef2ff;
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 12px;
      color: #111827;
      white-space: pre-wrap;
    }

    #ai-response pre {
      background: #0f172a;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 10px;
      overflow-x: auto;
      margin-top: 8px;
    }

    #ai-input {
      width: 100%;
      height: 90px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      resize: none;
    }

    .ai-send-btn {
      margin-top: 8px;
      width: 100%;
      background: linear-gradient(135deg, #4f46e5, #3b82f6);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(59, 130, 246, .35);
    }

    .ai-send-btn:hover {
      transform: translateY(-1px);
    }

    #insert-ai-btn {
      display: none;
      margin-top: 8px;
      padding: 8px 12px;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
    }

    #ai-popup-resizer {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 14px;
      height: 14px;
      cursor: se-resize;
      z-index: 2002;
    }

    #ai-popup-resizer::after {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 10px;
      height: 10px;
      border-right: 2px solid rgba(0, 0, 0, .12);
      border-bottom: 2px solid rgba(0, 0, 0, .12);
    }

    @media (max-width: 576px) {
      #ai-floating-btn {
        bottom: 16px;
        right: 16px;
      }

      #ai-popup {
        bottom: 80px;
        right: 12px;
        width: calc(100vw - 24px);
      }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
        <img src="{% static 'images/Screenshot 2025-08-14 091503.jpg' %}" alt="MB Logo" style="height: 60px; margin-right: 10px;" />
        <span class="fs-1">MY BLOGS</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
        aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarContent">
        <!-- Left links -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="functionDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Blog Options</a>
            <ul class="dropdown-menu custom-dropdown-menu shadow" aria-labelledby="functionDropdown">
              <li><a class="dropdown-item" href="{% url 'all_blogs' %}"><i class="bi bi-journal-text me-2 text-info"></i>All Blogs</a></li>
              <li><a class="dropdown-item" href="{% url 'blog' %}"><i class="bi bi-pencil-square me-2 text-warning"></i>Create Blogs</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="optionsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Options</a>
            <ul class="dropdown-menu custom-dropdown-menu shadow" aria-labelledby="optionsDropdown">
              <li><a class="dropdown-item" href="{% url 'about' %}"><i class="bi bi-info-circle me-2 text-primary"></i>About Us</a></li>
              <li><a class="dropdown-item" href="{% url 'contact' %}"><i class="bi bi-envelope me-2 text-success"></i>Contact Us</a></li>
              <li><a class="dropdown-item" href="{% url 'feedback' %}"><i class="bi bi-chat-dots me-2 text-warning"></i>Feedback</a></li>
            </ul>
          </li>
        </ul>

        <!-- Right side: Search + User -->
        <div class="nav-utility d-flex align-items-center gap-2">
          <form class="d-flex me-2" role="search" method="get" action="{% url 'all_blogs' %}">
            <input class="form-control me-2" type="search" name="q" value="{{ request.GET.q|default_if_none:'' }}" placeholder="Search..." aria-label="Search" />
            <button class="btn btn-outline-success" type="submit" aria-label="Search"><i class="bi bi-search"></i></button>
          </form>

          {% if user.is_authenticated %}
            <a href="{% url 'profile' %}" class="btn btn-outline-light d-flex align-items-center gap-2 btn-auth">
              <span class="avatar-badge">
                {% if user.profile and user.profile.initials %}
                  {{ user.profile.initials }}
                {% else %}
                  {% if user.first_name and user.last_name %}
                    {{ user.first_name|slice:':1'|upper }}{{ user.last_name|slice:':1'|upper }}
                  {% else %}
                    {{ user.username|slice:':1'|upper }}{{ user.username|slice:'1:2'|upper|default:user.username|slice:':1'|upper }}
                  {% endif %}
                {% endif %}
              </span>
              {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}
            </a>
          {% else %}
            <a href="{% url 'login' %}" class="btn btn-outline-light btn-auth">Login</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    {% block pagecontent %}{% endblock %}
  </div>

  <!-- Floating button -->
  <button id="ai-floating-btn" aria-label="Open AI Assistant">ðŸ¤–</button>

  <!-- AI popup -->
  <div id="ai-popup" role="dialog" aria-modal="false" aria-hidden="true">
    <div id="ai-popup-header">
      <span>AI Assistant</span>
      <button id="ai-popup-close" aria-label="Close">âœ–</button>
    </div>
    <div id="ai-popup-body">
      <div id="ai-response" aria-live="polite"></div>
      <textarea id="ai-input" placeholder="ðŸ‘‹ Hi! Iâ€™m your AI Assistant. "></textarea>
      <button id="ai-send" class="ai-send-btn">Send</button>
      <button id="insert-ai-btn">âž• Insert into Blog</button>
    </div>
    <div id="ai-popup-resizer" title="Drag to resize"></div>
  </div>

  <footer>
    <div class="container text-center">
      <div class="row mb-3">
        <div class="col-md-4">
          <h5>About</h5>
          <p>Your go-to place for amazing blog posts and fresh content every day.</p>
        </div>
        <div class="col-md-4">
          <h5>Quick Links</h5>
          <ul class="list-unstyled">
            <li><a href="{% url 'home' %}">Home</a></li>
            <li><a href="{% url 'all_blogs' %}">Blogs</a></li>
            <li><a href="{% url 'contact' %}">Contact</a></li>
            <li><a href="{% url 'about' %}">About</a></li>
          </ul>
        </div>
        <div class="col-md-4">
          <h5>Follow Us</h5>
          <div class="footer-social">
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-twitter"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom text-center">&copy; {{ now.year }} My Blogs. All rights reserved.</div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Your site JS -->
  <script src="{% static 'js/app.js' %}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // safety helper for highlight
      if (window.hljs && typeof hljs.highlightAll === 'function') {
        try { hljs.highlightAll(); } catch (e) { }
      }

      // navbar hover (desktop)
      if (window.matchMedia('(min-width: 992px)').matches && window.matchMedia('(hover: hover)').matches) {
        document.querySelectorAll('.navbar .dropdown').forEach(function (dropdown) {
          dropdown.addEventListener('mouseenter', function () {
            const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
            if (!toggle) return;
            bootstrap.Dropdown.getOrCreateInstance(toggle).show();
          });
          dropdown.addEventListener('mouseleave', function () {
            const toggle = dropdown.querySelector('[data-bs-toggle="dropdown"]');
            if (!toggle) return;
            bootstrap.Dropdown.getOrCreateInstance(toggle).hide();
          });
        });
      }

      // pause animations when tab inactive
      document.addEventListener('visibilitychange', function () {
        document.body.style.animationPlayState = document.hidden ? 'paused' : 'running';
      });

      // lazy loading images
      document.querySelectorAll('img:not([loading])').forEach((img) => img.setAttribute('loading', 'lazy'));

      // AI popup functionality
      const aiBtn = document.getElementById('ai-floating-btn');
      const popup = document.getElementById('ai-popup');
      const header = document.getElementById('ai-popup-header');
      const closeBt = document.getElementById('ai-popup-close');
      const sendBtn = document.getElementById('ai-send');
      const input = document.getElementById('ai-input');
      const outBox = document.getElementById('ai-response');
      const insertBtn = document.getElementById('insert-ai-btn');
      const resizer = document.getElementById('ai-popup-resizer');

      function getCSRFToken() {
        let cookieValue = null;
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, 10) === 'csrftoken=') {
            cookieValue = decodeURIComponent(cookie.substring(10));
            break;
          }
        }
        return cookieValue;
      }

      if (aiBtn && popup) {
        aiBtn.addEventListener('click', () => {
          const isOpen = popup.style.display === 'flex';
          if (isOpen) {
            popup.style.display = 'none';
            popup.setAttribute('aria-hidden', 'true');
          } else {
            popup.style.display = 'flex';
            popup.style.flexDirection = 'column';
            popup.setAttribute('aria-hidden', 'false');
            setTimeout(() => {
              try { outBox.parentElement.scrollTop = outBox.parentElement.scrollHeight; } catch (e) { }
            }, 80);
          }
        });
      }

      if (closeBt && popup) {
        closeBt.addEventListener('click', () => {
          popup.style.display = 'none';
          popup.setAttribute('aria-hidden', 'true');
        });
      }

      // sending request to your Django ai_assistant view
      if (sendBtn && input && outBox) {
        sendBtn.addEventListener('click', async () => {
          const text = (input.value || '').trim();
          if (!text) {
            alert('Please type something for the AI.');
            return;
          }

          sendBtn.disabled = true;
          sendBtn.innerText = 'Thinking...';

          const bubble = document.createElement('div');
          bubble.className = 'ai-bubble';
          bubble.textContent = 'â€¦';
          outBox.appendChild(bubble);
          try {
            try { outBox.parentElement.scrollTop = outBox.parentElement.scrollHeight; } catch (e) { }

            const res = await fetch("https://my-new-blogs.onrender.com/ai-assistant/", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
              },
              body: JSON.stringify({ text })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'AI request failed');

            bubble.innerHTML = data.suggestion || 'âœ¨ (No suggestion returned)';
            try { if (window.hljs && hljs.highlightAll) hljs.highlightAll(); } catch (e) { }
            if (insertBtn) insertBtn.style.display = 'block';
          } catch (err) {
            bubble.textContent = `âš ï¸ ${err.message}`;
          } finally {
            sendBtn.disabled = false;
            sendBtn.innerText = 'Send';
            input.value = '';
            try { outBox.parentElement.scrollTop = outBox.parentElement.scrollHeight; } catch (e) { }
          }
        });

        input.addEventListener('keydown', function (e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            sendBtn.click();
          }
        });
      }

      // Insert into editor: Quill -> #id_content -> clipboard -> prompt
      if (insertBtn && outBox) {
        insertBtn.addEventListener('click', function () {
          const suggestionHtml = outBox.innerHTML || '';

          function stripHtml(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || '';
          }

          const plain = stripHtml(suggestionHtml);

          if (window.quill && typeof window.quill.insertText === 'function') {
            try {
              const q = window.quill;
              const sel = q.getSelection && q.getSelection(true);
              const index = (sel && sel.index) || q.getLength();
              q.insertText(index, '\n' + plain + '\n', 'user');
              q.setSelection(index + plain.length + 2, 0);
              alert('Inserted into editor.');
              return;
            } catch (e) { }
          }

          const hidden = document.getElementById('id_content');
          if (hidden) {
            hidden.value = (hidden.value || '') + '\n' + plain + '\n';
            alert('Inserted into blog content field.');
            return;
          }

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(plain).then(() => {
              alert('Suggestion copied to clipboard. Paste it where you want (Ctrl+V).');
            }).catch(() => {
              alert('Could not copy to clipboard, please copy manually:\n\n' + plain);
            });
            return;
          }

          prompt('Copy the suggestion below:', plain);
        });
      }

      // draggable popup by header
      (function makeDraggable() {
        const headerEl = document.getElementById('ai-popup-header');
        const popupEl = document.getElementById('ai-popup');
        if (!headerEl || !popupEl) return;

        let dragging = false, startX = 0, startY = 0, startRect = null;

        function onDown(e) {
          if (e.button !== 0) return;
          dragging = true;
          startX = e.clientX;
          startY = e.clientY;
          startRect = popupEl.getBoundingClientRect();
          popupEl.style.position = 'fixed';
          popupEl.style.left = startRect.left + 'px';
          popupEl.style.top = startRect.top + 'px';
          popupEl.style.right = 'auto';
          popupEl.style.bottom = 'auto';
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
          e.preventDefault();
        }

        function onMove(e) {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          popupEl.style.left = (startRect.left + dx) + 'px';
          popupEl.style.top = (startRect.top + dy) + 'px';
        }

        function onUp() {
          if (!dragging) return;
          dragging = false;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }

        headerEl.addEventListener('mousedown', onDown);
      })();

      // resizable
      (function makeResizable() {
        const resizerEl = document.getElementById('ai-popup-resizer');
        const popupEl = document.getElementById('ai-popup');
        if (!resizerEl || !popupEl) return;

        let resizing = false, sX = 0, sY = 0, sW = 0, sH = 0;

        function onDown(e) {
          if (e.button !== 0) return;
          resizing = true;
          sX = e.clientX;
          sY = e.clientY;
          const r = popupEl.getBoundingClientRect();
          sW = r.width;
          sH = r.height;
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
          e.preventDefault();
        }

        function onMove(e) {
          if (!resizing) return;
          const dx = e.clientX - sX;
          const dy = e.clientY - sY;
          popupEl.style.width = Math.max(260, sW + dx) + 'px';
          popupEl.style.height = Math.max(180, sH + dy) + 'px';
        }

        function onUp() {
          if (!resizing) return;
          resizing = false;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }

        resizerEl.addEventListener('mousedown', onDown);
      })();
    });
  </script>
</body>

</html>
